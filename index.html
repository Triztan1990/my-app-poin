<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>PinBonus AI Platinum v26.0 (General + Data)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #f8fafc; --accent: #1d4ed8; }
    body { background-color: var(--bg); font-family: 'Poppins', sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
    .glass { background: #ffffff; border: 1px solid rgba(0,0,0,0.05); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    #loginScreen { position: fixed; inset: 0; z-index: 9999; background: #f8fafc; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #mainApp { display: none; position: relative; z-index: 10; }

    .header-bonus { background: linear-gradient(135deg, #1d4ed8, #3b82f6); color: white; border-radius: 2rem; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 20px -5px rgba(29, 78, 216, 0.3); }
    
    .acc-item { overflow: hidden; transition: 0.3s; border-radius: 1rem; margin-bottom: 8px; }
    .acc-content { max-height: 0; opacity: 0; transition: 0.3s; font-size: 11px; }
    .acc-item.open .acc-content { max-height: 150px; opacity: 1; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f1f5f9; }
    .nav-active { background: #eff6ff; color: var(--accent) !important; font-weight: 800; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loginScreen">
      <div class="w-16 h-16 bg-blue-700 rounded-3xl mb-6 flex items-center justify-center shadow-2xl animate-bounce"><i class="fa fa-cloud text-white text-3xl"></i></div>
      <h1 class="text-3xl font-800 text-slate-800 mb-8 tracking-tighter">PinBonus AI</h1>
      <button id="btnLogin" class="flex items-center gap-4 bg-white px-10 py-4 rounded-2xl shadow-xl font-bold border border-slate-100 active:scale-95 transition-all text-slate-700"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Google Login</button>
  </div>

  <div id="mainApp">
    <div class="max-w-md mx-auto p-4 pb-28">
        
        <header class="flex justify-between items-center mb-4 p-2">
            <h1 class="text-xl font-800 text-slate-800">Dashboard</h1>
            <div class="flex gap-2">
                <button onclick="toggleVoice()" class="w-9 h-9 glass rounded-xl flex items-center justify-center text-blue-600"><i id="voiceIcon" class="fa fa-volume-up"></i></button>
                <button onclick="logout()" class="w-9 h-9 glass rounded-xl flex items-center justify-center text-red-400"><i class="fa fa-sign-out"></i></button>
            </div>
        </header>

        <div class="header-bonus flex justify-between items-center">
            <div><p class="text-[10px] font-black opacity-70 uppercase tracking-widest">Bonus Hari Ini</p><p class="text-3xl font-900 tracking-tighter">Rp <span id="totalDisplay">0</span></p></div>
            <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-2xl"><i class="fa fa-money text-white"></i></div>
        </div>

        <div id="viewInput" class="tab-content active">
            <div class="glass rounded-[2rem] p-6 shadow-sm">
                <div class="space-y-3">
                    <select id="cat" class="w-full p-4 glass rounded-2xl text-xs font-bold outline-none ring-1 ring-slate-100"></select>
                    <select id="svc" class="w-full p-4 glass rounded-2xl text-xs font-bold outline-none ring-1 ring-slate-100" disabled></select>
                    <select id="sku" class="w-full p-4 glass rounded-2xl text-xs font-bold outline-none ring-2 ring-blue-50" disabled></select>
                    <input type="text" id="orderId" placeholder="ID Order (Opsional)..." class="w-full p-4 glass rounded-2xl text-xs font-bold outline-none ring-1 ring-slate-100">
                </div>
                <button id="addBtn" class="w-full bg-blue-700 text-white py-4 rounded-2xl font-800 mt-5 shadow-lg active:scale-95">SIMPAN DATA</button>
            </div>
        </div>

        <div id="viewAi" class="tab-content">
            <div class="glass rounded-[2rem] p-4 flex flex-col h-[400px] shadow-sm">
                <div id="aiChatBox" class="flex-1 overflow-y-auto p-2">
                     <div class="p-3 bg-slate-100 text-slate-700 rounded-2xl mr-auto text-xs font-bold mb-2 max-w-[80%]">
                        <b>AI:</b> Halo! Saya bisa bantu soal pekerjaan atau ngobrol santai soal apa saja. Mau tanya apa?
                     </div>
                </div>
                <div class="flex gap-2 p-2 bg-slate-50 rounded-2xl mt-4 border border-slate-100">
                    <input type="text" id="aiInput" placeholder="Ketik apa saja..." class="flex-1 bg-transparent p-2 text-xs font-bold outline-none">
                    <button onclick="askAI()" class="w-10 h-10 bg-indigo-600 text-white rounded-xl shadow-lg"><i class="fa fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="viewHistory" class="tab-content">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-[10px] font-black opacity-30 uppercase tracking-widest">Management</h2>
                <div class="flex gap-2">
                    <button onclick="resetAllData()" class="p-2 bg-red-50 text-red-600 rounded-lg border border-red-100"><i class="fa fa-trash"></i></button>
                    <button onclick="sendWA()" class="p-2 bg-green-50 text-green-600 rounded-lg"><i class="fa fa-whatsapp"></i></button>
                    <button onclick="openExportMenu()" class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i class="fa fa-file-excel-o"></i></button>
                </div>
            </div>
            
            <button id="btnShowAll" onclick="toggleLimit()" class="w-full mb-4 py-3 bg-white border border-slate-200 rounded-2xl text-[9px] font-black text-blue-600 uppercase tracking-widest shadow-sm active:bg-blue-50">
                <i class="fa fa-eye mr-2"></i> Lihat Semua Data
            </button>
            
            <ul id="jobList" class="space-y-2"></ul>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 h-20 glass rounded-t-[2.5rem] flex justify-around items-center px-6 z-50 shadow-2xl">
            <button onclick="switchTab('input')" id="navIn" class="nav-btn nav-active flex flex-col items-center opacity-40"><i class="fa fa-pencil-square-o text-xl"></i><span class="text-[8px] mt-1 font-black uppercase">Input</span></button>
            <button onclick="switchTab('ai')" id="navAi" class="nav-btn flex flex-col items-center opacity-40"><i class="fa fa-magic text-xl"></i><span class="text-[8px] mt-1 font-black uppercase">AI Groq</span></button>
            <button onclick="switchTab('history')" id="navHis" class="nav-btn flex flex-col items-center opacity-40"><i class="fa fa-list-ul text-xl"></i><span class="text-[8px] mt-1 font-black uppercase">Data</span></button>
        </nav>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaulpvROT6vO1-LjK3bae3ETnpWz4irIw",
      authDomain: "pinbonus-kalkulasi.firebaseapp.com",
      projectId: "pinbonus-kalkulasi",
      storageBucket: "pinbonus-kalkulasi.firebasestorage.app",
      messagingSenderId: "950589733342",
      appId: "1:950589733342:web:6bbc9647077a8c40e1454f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let userUID = null, cart = [], master = [], VOICE_ON = true, isFullList = false;

    window.speak = (t) => { if(VOICE_ON) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang='id-ID'; window.speechSynthesis.speak(m); } };
    window.toggleVoice = () => { VOICE_ON = !VOICE_ON; document.getElementById('voiceIcon').className = VOICE_ON ? 'fa fa-volume-up' : 'fa fa-volume-off opacity-30'; };
    window.logout = () => signOut(auth).then(() => location.reload());
    document.getElementById('btnLogin').onclick = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, (user) => {
        if(user) {
            userUID = user.uid;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            initData();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }
    });

    async function initData() {
        const r = await fetch("https://script.google.com/macros/s/AKfycbyUtuyUhIXT9uZwd6xZ38JV18rzFUns87AvS4AsST1eun1BQAFtNZGfpmv-mthucDDP/exec");
        const j = await r.json(); master = j.data;
        document.getElementById('cat').innerHTML = '<option value="">Pilih Kategori...</option>' + [...new Set(master.map(i => i.category))].sort().map(c => `<option value="${c}">${c}</option>`).join('');
        onSnapshot(doc(db, "users", userUID), (d) => { if(d.exists()){ cart = d.data().bonus || []; render(); } });
    }

    window.toggleLimit = () => {
        isFullList = !isFullList;
        document.getElementById('btnShowAll').innerHTML = isFullList ? '<i class="fa fa-eye-slash mr-2"></i> Tampilkan Sedikit' : '<i class="fa fa-eye mr-2"></i> Lihat Semua Data';
        render();
    };

    window.render = () => {
        const list = document.getElementById('jobList');
        let tot = 0; const td = new Date().toLocaleDateString('id-ID');
        list.innerHTML = "";
        const sortedData = [...cart].sort((a,b) => b.id - a.id);
        const displayData = isFullList ? sortedData : sortedData.slice(0, 5);

        cart.forEach(i => { if(i.date === td) tot += (Number(i.price) || 0); });

        displayData.forEach(i => {
            const v = Number(i.price) || 0;
            list.innerHTML += `
                <li class="acc-item glass p-4 shadow-sm border-l-4 border-blue-600 cursor-pointer" onclick="this.classList.toggle('open')">
                    <div class="flex justify-between items-center">
                        <span class="text-[11px] font-black text-slate-700 uppercase">${i.name}</span>
                        <span class="text-[12px] font-black text-blue-700">Rp${v.toLocaleString('id-ID')}</span>
                    </div>
                    <div class="acc-content">
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div><p class="text-[9px] font-black text-slate-300 uppercase">TANGGAL</p><p class="text-[10px] font-bold text-slate-600">${i.date}</p></div>
                            <div><p class="text-[9px] font-black text-slate-300 uppercase">JAM</p><p class="text-[10px] font-bold text-slate-600">${i.time}</p></div>
                        </div>
                        <div class="flex justify-between items-end">
                            <div><p class="text-[9px] font-black text-slate-300 uppercase">ID ORDER</p><p class="text-[10px] font-bold text-blue-600">${i.order}</p></div>
                            <button onclick="event.stopPropagation(); deleteItem(${i.id})" class="bg-red-50 text-red-500 px-3 py-1 rounded-lg text-[9px] hover:bg-red-100 font-black border border-red-100">HAPUS</button>
                        </div>
                    </div>
                </li>`;
        });
        document.getElementById('totalDisplay').innerText = tot.toLocaleString('id-ID');
    };

    window.deleteItem = async (id) => {
        if(!confirm("Hapus data ini?")) return;
        const newCart = cart.filter(item => item.id !== id);
        await setDoc(doc(db, "users", userUID), { bonus: newCart }, { merge: true });
        speak("Data terhapus");
    };

    window.resetAllData = async () => {
        if(prompt("Ketik RESET untuk hapus semua:") !== 'RESET') return;
        await setDoc(doc(db, "users", userUID), { bonus: [] }, { merge: true });
        speak("Data bersih");
    };

    // --- AI LOGIC YANG DILONGGARKAN (GENERAL + HYBRID) ---
    window.askAI = async () => {
        const inp = document.getElementById('aiInput'); 
        const box = document.getElementById('aiChatBox');
        if(!inp.value) return; 
        const q = inp.value; 
        inp.value = "";
        
        box.innerHTML += `<div class="p-3 bg-blue-600 text-white rounded-2xl ml-auto text-xs font-bold mb-2 max-w-[80%]">${q}</div>`;
        box.scrollTop = box.scrollHeight;
        
        // HITUNG DATA (DIAM-DIAM)
        const today = new Date().toLocaleDateString('id-ID');
        const todayItems = cart.filter(i => i.date === today);
        const totalHariIni = todayItems.reduce((acc, curr) => acc + (Number(curr.price)||0), 0);
        
        // --- INSTRUKSI HYBRID ---
        // Kita beri tahu AI: Kamu itu pintar segalanya. TAPI ini data usernya.
        // Kalau dia tanya umum, jawab umum. Kalau tanya bonus, pakai data ini.
        const contextData = `
        [PERAN]
        Anda adalah Asisten Pribadi yang cerdas, ramah, dan serba bisa (General AI).
        Anda bisa menjawab pertanyaan umum (sejarah, sains, tips, coding, resep, dll) dengan leluasa.
        
        [DATA PENGGUNA SAAT INI]
        HANYA gunakan data di bawah ini JIKA user bertanya tentang "bonus", "uang", "pekerjaan", atau "laporan":
        - Total Bonus Hari Ini: Rp ${totalHariIni.toLocaleString('id-ID')}
        - Jumlah Job Hari Ini: ${todayItems.length}
        - Rincian Job: ${todayItems.map(i => i.name).join(', ') || 'Belum ada'}

        [ATURAN]
        1. Jika user bertanya "Apa resep soto?", jawab resep soto (abaikan data bonus).
        2. Jika user bertanya "Berapa bonus saya?", baru gunakan data di atas.
        `;

        const finalPrompt = contextData + "\n\nUser: " + q;

        try {
            const res = await fetch(`https://script.google.com/macros/s/AKfycbwdlOCivWIyMglDCMCR6fD_rx6fCybcy7rQvwVpiEfor-696Dq_CHIpeQ4jhsJI1fJu/exec?action=ai&prompt=${encodeURIComponent(finalPrompt)}`);
            const data = await res.json();
            const reply = data.reply || data.message || "Maaf, coba lagi.";
            
            box.innerHTML += `<div class="p-3 bg-slate-100 text-slate-700 rounded-2xl mr-auto text-xs font-bold mb-2 max-w-[80%]"><b>AI:</b> ${reply}</div>`;
            speak(reply);
        } catch(e) { speak("Gagal koneksi"); }
        box.scrollTop = box.scrollHeight;
    };

    window.switchTab = (t) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('view' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
        document.getElementById(t==='input'?'navIn':t==='ai'?'navAi':'navHis').classList.add('nav-active');
    };

    document.getElementById('addBtn').onclick = async () => {
        const sku = document.getElementById('sku');
        const p = parseFloat(sku.value), n = sku.options[sku.selectedIndex]?.getAttribute('data-n');
        if(!p) return;
        const data = { id: Date.now(), order: document.getElementById('orderId').value || "-", name: n, price: p, time: new Date().toLocaleTimeString('id-ID'), date: new Date().toLocaleDateString('id-ID')};
        await setDoc(doc(db, "users", userUID), { bonus: arrayUnion(data) }, { merge: true });
        document.getElementById('orderId').value = ""; 
        speak(n + " senilai " + p.toLocaleString() + " rupiah, berhasil disimpan.");
    };

    document.getElementById('cat').onchange = () => {
        const s = document.getElementById('svc'); s.disabled = !document.getElementById('cat').value;
        s.innerHTML = '<option value="">Layanan...</option>';
        if(!s.disabled) s.innerHTML += [...new Set(master.filter(i => i.category === document.getElementById('cat').value).map(i => i.service))].sort().map(sv => `<option value="${sv}">${sv}</option>`).join('');
    };
    document.getElementById('svc').onchange = () => {
        const sk = document.getElementById('sku'); sk.disabled = !document.getElementById('svc').value;
        sk.innerHTML = '<option value="">SKU...</option>';
        if(!sk.disabled) sk.innerHTML += master.filter(i => i.category === document.getElementById('cat').value && i.service === document.getElementById('svc').value).map(i => `<option value="${i.nominal_angka}" data-n="${i.sku_name}">${i.sku_name}</option>`).join('');
    };
    
    window.openExportMenu = () => { const ws = XLSX.utils.json_to_sheet(cart); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Database"); XLSX.writeFile(wb, "Data_PinBonus.xlsx"); };
    window.sendWA = () => { let t = "*LAPORAN*\n"; cart.filter(i => i.date === new Date().toLocaleDateString('id-ID')).forEach(i => t += `- ${i.name}: Rp${i.price.toLocaleString()}\n`); window.open("https://wa.me/?text=" + encodeURIComponent(t)); };
  </script>
</body>
</html>
