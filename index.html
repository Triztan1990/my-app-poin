<!DOCTYPE html>  
<html lang="id">  
<head>  
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">  
  <title>Hitung Poin HomeSol</title>  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">  
  <style>  
    /* --- THEME VARIABLES (Light & Dark Mode) --- */  
    :root {  
      --primary: #4361ee; --primary-light: #4895ef; --danger: #f72585;  
      --warning: #f8961e; --success: #38b000; --offline: #dc3545;  
      --light: #f8f9fa; --dark: #212529; --border-color: #dee2e6;  
      --bg-color: #f5f7ff; --card-bg: white; --text-color: #212529;  
      --text-muted: #6c757d; --shadow-color: rgba(0,0,0,0.08);  
      --border-radius: 10px; --transition-speed: 0.3s;  
    }  
    body.dark-mode {  
      --primary: #4895ef; --primary-light: #53a1f1; --danger: #f75099;  
      --warning: #ffaa3d; --success: #5cb85c; --offline: #f75099;  
      --light: #343a40; --dark: #f8f9fa; --border-color: #495057;  
      --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #f8f9fa;  
      --text-muted: #adb5bd; --shadow-color: rgba(255, 255, 255, 0.08);  
    }  
    /* --- Base Styles & Transitions --- */  
    body {  
      font-family: 'Poppins', sans-serif; background-color: var(--bg-color);  
      margin: 0; padding: 20px; color: var(--text-color);  
      transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;  
      line-height: 1.6;  
    }  
    .container { max-width: 830px; margin: 0 auto; }  
    * { box-sizing: border-box; }  
    /* --- Header --- */  
    .app-header {  
      display: flex; align-items: center; gap: 15px; margin-bottom: 25px;  
      padding-bottom: 10px; border-bottom: 1px solid var(--border-color);  
      transition: border-color var(--transition-speed) ease;  
    }  
    .crown-icon { color: gold; font-size: 28px; text-shadow: 0 0 4px rgba(0,0,0,0.4); }  
    .app-header h1 { font-weight: 600; margin: 0; font-size: 1.5em; color: var(--text-color); transition: color var(--transition-speed) ease; }  
    .status-container { margin-left: auto; display: flex; align-items: center; gap: 15px; }  
    .status-indikator { padding: 5px 14px; border-radius: 20px; font-weight: 500; font-size: 0.9em; display: flex; align-items: center; gap: 5px; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; }  
    .status-indikator .spinner { display: none; width: 1em; height: 1em; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 5px; }  
    .status-indikator.loading .spinner { display: inline-block; }  
    .status-indikator.loading .status-text { display: none; } /* Sembunyikan teks saat loading */  
    .online { background: var(--success); color: white; }  
    .offline { background: var(--offline); color: white; }  
    #darkModeToggle { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.3em; padding: 5px; transition: color var(--transition-speed) ease; }  
    #darkModeToggle:hover { color: var(--primary); }  
    @keyframes spin { to { transform: rotate(360deg); } }  
    /* --- Tabs --- */  
    .tabs { display: flex; margin-bottom: 20px; gap: 8px; flex-wrap: wrap; }  
    .tablink { padding: 10px 18px; cursor: pointer; background-color: var(--light); border-radius: 6px 6px 0 0; border: 1px solid var(--border-color); border-bottom: none; font-family: 'Poppins'; font-weight: 500; color: var(--text-muted); transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease; margin-bottom: -1px; }  
    .tablink.active, .tablink:hover { background-color: var(--primary); color: white; border-color: var(--primary); }  
    .tabcontent { display: none; background: var(--card-bg); padding: 25px 20px; border-radius: 0 var(--border-radius) var(--border-radius) var(--border-radius); box-shadow: 0 4px 15px var(--shadow-color); margin-bottom: 30px; border: 1px solid var(--border-color); transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; opacity: 0; animation: fadeIn 0.5s forwards; }  
    .tabcontent.active-content { display: block; }  
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }  
    /* --- Card --- */  
    .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: 0 4px 15px var(--shadow-color); padding: 22px; margin-bottom: 25px; border: 1px solid var(--border-color); transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }  
    .card h3 { margin-top: 0; margin-bottom: 18px; color: var(--primary); font-weight: 600; }  
    /* --- Tabel --- */  
    table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }  
    th, td { padding: 14px 12px; border-bottom: 1px solid var(--border-color); text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: border-color var(--transition-speed) ease; }  
    th { background-color: var(--primary); color: white; font-weight: 500; }  
    tr { transition: background-color 0.2s ease; }  
    tbody tr:hover { background-color: rgba(0,0,0,0.03); }  
    body.dark-mode tbody tr:hover { background-color: rgba(255,255,255,0.05); }  
    .poin-column { display: flex; align-items: center; justify-content: space-between; }  
    @keyframes rowFadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }  
    @keyframes rowFadeOut { from { opacity: 1; } to { opacity: 0; transform: scaleY(0.1); } }  
    .row-fade-in { animation: rowFadeIn 0.4s ease forwards; }  
    .row-fade-out { animation: rowFadeOut 0.4s ease forwards; }  
    /* --- Tombol & Input --- */  
    .point-action { display: flex; align-items: center; justify-content: space-between; gap: 10px; }  
    .btn-icon { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 1.1em; padding: 5px; transition: color 0.2s ease; }  
    .btn-icon:hover { color: #c00; }  
    body.dark-mode .btn-icon:hover { color: #ff7a8a; }  
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-family: 'Poppins'; font-weight: 500; transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; }  
    .btn:active { transform: scale(0.98); }  
    .btn-primary { background-color: var(--primary); color: white; }  
    .btn-primary:hover { background-color: var(--primary-light); box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3); }  
    .btn-danger { background-color: var(--danger); color: white; }  
    .btn-danger:hover { background-color: #d01a6a; box-shadow: 0 2px 8px rgba(247, 37, 133, 0.3); }  
    .btn-warning { background-color: var(--warning); color: white; }  
    .btn-warning:hover { background-color: #d88010; box-shadow: 0 2px 8px rgba(248, 150, 30, 0.3); }  
    .btn-success { background-color: var(--success); color: white; }  
    .btn-success:hover { background-color: #2b8000; box-shadow: 0 2px 8px rgba(56, 176, 0, 0.3); }  
    .btn-feedback { background-color: var(--success) !important; cursor: default !important; transform: none !important; box-shadow: none !important; }  
    input, select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: 'Poppins'; background-color: var(--card-bg); color: var(--text-color); transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease, color var(--transition-speed) ease; }  
    input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2); }  
    input[type="number"] { text-align: center; }  
    input::placeholder { color: var(--text-muted); }  
    /* --- Chart & Statistik --- */  
    #layananChart { height: 260px !important; max-height: 260px; background: transparent; border-radius: 6px; margin-top: 20px; transition: background-color var(--transition-speed) ease; }  
    .stat-label { font-weight: 500; color: var(--primary); }  
    /* --- Progress Bar --- */  
    .progress-card { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 25px; }  
    .progress-card h3 { color: white; }  
    .target-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }  
    .target-input-group label { font-weight: 500; flex-shrink: 0; }  
    .target-input-group input { width: auto; flex-grow: 1; text-align: right; background-color: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); color: white; }  
    .progress-container { background-color: rgba(255, 255, 255, 0.2); border-radius: 20px; height: 12px; overflow: hidden; margin-bottom: 8px; }  
    .progress-bar { background-color: var(--success); height: 100%; width: 0%; border-radius: 20px; transition: width 0.5s ease-out; }  
    .progress-text { font-size: 0.95em; text-align: center; }  
    /* --- Responsif (Mobile) --- */  
    @media (max-width: 600px) {  
      body { padding: 10px; }  
      .container { padding: 0px; }  
      .card, .tabcontent { padding: 15px; border-radius: 0; border-left: none; border-right: none; margin-bottom: 10px; box-shadow: none; }  
      .card:first-child { border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); border-top: 1px solid var(--border-color);}  
      .card:last-child { border-bottom-left-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); border-bottom: 1px solid var(--border-color);}  
      .tabcontent { border-radius: 0 0 var(--border-radius) var(--border-radius); box-shadow: 0 4px 15px var(--shadow-color); }  
      table, th, td { font-size: 13px; }  
      th, td { padding: 10px 8px; white-space: normal; }  
      th:nth-child(1), td:nth-child(1) { width: 30%; }  
      th:nth-child(2), td:nth-child(2) { width: 45%; }  
      th:nth-child(3), td:nth-child(3) { width: 25%; }  
      h1, h2, h3, h4 { font-size: 1.1em; }  
      .app-header h1 { font-size: 1.2em; }  
      .btn { padding: 8px 14px; font-size: 0.9em; }  
      input, select { padding: 10px; font-size: 0.9em;}  
      .history-header { flex-direction: column; align-items: flex-start; gap: 10px; }  
      .history-header > div { margin-left: 0; width: 100%; display: flex; gap: 8px; justify-content: flex-start; }  
      #layananChart { height: 200px !important; max-height: 200px; }  
      .progress-card { border-radius: var(--border-radius); }  
    }  
    /* --- Splash Screen --- */  
    .splash-screen { /* ... (splash screen style tidak berubah) ... */  
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;  
      background-color: var(--primary); display: flex; flex-direction: column;  
      justify-content: center; align-items: center; z-index: 9999;  
    }  
    .splash-screen h1 { color: white; font-size: 24px; margin-top: 20px; text-align: center; padding: 0 15px; }  
  </style>  
  <!-- Script Failsafe Splash Screen -->  
  <script>  
    window.setTimeout(function() {  
      var splash = document.getElementById('splashScreen');  
      var mainApp = document.getElementById('mainApp');  
      if (splash && splash.style.display !== 'none') {  
        splash.style.display = 'none';  
        if (mainApp) mainApp.style.display = 'block';  
        console.log("Splash screen dihapus oleh failsafe timer");  
      }  
    }, 3500); // Timeout 3.5 detik  
  </script>  
</head>  
<body class=""> <!-- Class 'dark-mode' akan ditambahkan oleh JS -->  
  <!-- Splash Screen -->  
  <div id="splashScreen" class="splash-screen">  
    <i class="fas fa-crown crown-icon" style="font-size: 50px; color: gold;"></i>  
    <h1>Hitung Poin HomeSol</h1>  
  </div>  

  <!-- Konten Aplikasi Utama (Awalnya Tersembunyi) -->  
  <div id="mainApp" class="container" style="display:none;">  
    <!-- Header -->  
    <div class="app-header">  
      <i class="fas fa-crown crown-icon"></i>  
      <h1 style="font-weight:600; margin: 0;">HomeSol Points</h1>  
      <div class="status-container">  
         <!-- ID elemen ini HARUS cocok dengan selector JS -->  
         <span id="statusOnline" class="status-indikator offline">  
             <div class="spinner"></div>  
             <span class="status-text">Offline</span>  
         </span>  
         <button id="darkModeToggle" title="Ganti Tema"><i class="fa-solid fa-moon"></i></button>  
      </div>  
    </div>  

    <!-- Navigasi Tab -->  
    <div class="tabs">  
      <button class="tablink active" onclick="showTab('formTab', this)"><i class="fa-solid fa-pen-to-square"></i> Form</button>  
      <button class="tablink" onclick="showTab('chartTab', this)"><i class="fa-solid fa-chart-pie"></i> Grafik</button>  
      <button class="tablink" onclick="showTab('statTab', this)"><i class="fa-solid fa-chart-line"></i> Statistik</button>  
    </div>  

    <!-- Konten Tab: Form -->  
    <div id="formTab" class="tabcontent active-content">  
      <div class="card">  
        <h3><i class="fa-solid fa-plus"></i> Tambah Kerjaan Baru</h3>  
        <table>  
          <tr><td>Tanggal</td><td><input type="date" id="tanggal"></td></tr>  
          <tr><td>Layanan</td><td><select id="layanan" required><option value="">Memuat...</option></select></td></tr>  
          <tr><td>Paket</td><td><select id="paket" required><option value="">Pilih Layanan Dulu</option></select></td></tr>  
          <tr><td>Jumlah</td><td><input type="number" id="jumlah" min="1" value="1" oninput="updatePointByJumlah()"></td></tr>  
          <tr><td>Point</td><td>  
            <div class="point-action">  
              <div>  
                <span id="poinSatuan">0</span> Ã— <span id="displayJumlah">1</span> = <strong id="poin">0</strong>  
              </div>  
              <button id="btnTambah" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Tambah</button>  
            </div>  
          </td></tr>  
        </table>  
      </div>  

      <!-- Card Total & Progress -->  
      <div class="card progress-card">  
        <h3 style="text-align:center;">Poin & Target Mingguan</h3>  
        <div style="font-size: 2.2em; font-weight: 700; text-align: center; margin-bottom: 20px;" id="totalPoin">0</div>  
        <div class="target-input-group">  
            <label for="weeklyTargetInput">Target Minggu Ini:</label>  
            <input type="number" id="weeklyTargetInput" min="0" placeholder="0">  
        </div>  
        <div class="progress-container">  
            <div id="progressBar" class="progress-bar"></div>  
        </div>  
        <div id="progressText" class="progress-text">0 / 0 Poin (0%)</div>  
      </div>  

      <div class="card">  
        <!-- Header Tabel Kerjaan -->  
        <div class="history-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">  
          <h3 style="margin: 0;"><i class="fa-solid fa-list-check"></i> Daftar Kerjaan</h3>  
          <div>  
            <button class="btn btn-primary btn-sm" onclick="backupData()" title="Download data kerjaan Anda"><i class="fas fa-download"></i> Backup</button>  
            <button class="btn btn-warning btn-sm" onclick="document.getElementById('importFileInput').click()" title="Restore data dari file backup"><i class="fas fa-upload"></i> Restore</button>  
            <input type="file" id="importFileInput" accept=".json" style="display:none" onchange="restoreData(event)">  
            <button id="btnToggleHistory" class="btn btn-sm" style="margin-left: 8px;" title="Tampilkan/Sembunyikan tabel kerjaan"><i class="fas fa-eye"></i> Sembunyikan</button>  
          </div>  
        </div>  
        <!-- Tabel Kerjaan -->  
        <div id="historyTableContainer" style="overflow-x: auto;">  
          <table id="tabelKerjaan">  
            <thead><tr><th style="width:30%">Tanggal</th><th style="width:45%">Paket</th><th style="width:25%">Poin</th></tr></thead>  
            <tbody><!-- Data Kerjaan Dimasukkan di Sini --></tbody>  
          </table>  
        </div>  
      </div>  
    </div>  

    <!-- Konten Tab: Grafik -->  
    <div id="chartTab" class="tabcontent">  
      <h3><i class="fa-solid fa-chart-pie"></i> Proporsi Layanan</h3>  
      <canvas id="layananChart"></canvas>  
    </div>  

    <!-- Konten Tab: Statistik -->  
    <div id="statTab" class="tabcontent">  
      <h3><i class="fa-solid fa-calendar-days"></i> Statistik Poin</h3>  
      <div style="font-size:1.1em; padding:14px 0; line-height: 2;">  
        <div><span class="stat-label">Poin Hari Ini: </span><span id="statHarian">0</span></div>  
        <div><span class="stat-label">Poin Minggu Ini: </span><span id="statMingguan">0</span></div>  
        <div><span class="stat-label">Poin Bulan Ini: </span><span id="statBulanan">0</span></div>  
      </div>  
    </div>  
  </div> <!-- Akhir .container #mainApp -->  

  <!-- Library Chart.js -->  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  

  <!-- Script Aplikasi Utama -->  
  <script>  
    // --- KONFIGURASI ---  
    const API_URL = 'https://script.google.com/macros/s/AKfycbyuSjt7dlJLXB_283b7dQNpEWm3LAjcPEwnO8ho0nF6OH82x9jKqXuRjB6pKp_-OcfLBg/exec';  
    const LOCALSTORAGE_KEY = 'daftarKerjaanHomeSol';  
    const THEME_KEY = 'themePreferenceHomeSol';  
    const TARGET_KEY = 'weeklyTargetHomeSol';  
    const HISTORY_VISIBLE_KEY = 'historyVisibleHomeSol';  

    // --- VARIABEL GLOBAL ---  
    let layananData = {};  
    let daftarKerjaan = [];  
    let isHistoryVisible = true;  
    let online = false;  
    let chartInstance = null;  
    let weeklyTarget = 0;  
    let weeklyPoints = 0;  

    // --- DOM SELECTORS ---  
    const splashScreen = document.getElementById('splashScreen');  
    const mainApp = document.getElementById('mainApp');  
    // PERBAIKAN: Pastikan nama variabel ini cocok dengan ID di HTML  
    const statusOnline = document.getElementById('statusOnline');  
    const statusText = statusOnline.querySelector('.status-text'); // Gunakan variabel yg sudah diperbaiki  
    const darkModeToggle = document.getElementById('darkModeToggle');  
    const bodyEl = document.body;  
    const tanggalEl = document.getElementById('tanggal');  
    const layananEl = document.getElementById('layanan');  
    const paketEl = document.getElementById('paket');  
    const jumlahEl = document.getElementById('jumlah');  
    const poinSatuanEl = document.getElementById('poinSatuan');  
    const displayJumlahEl = document.getElementById('displayJumlah');  
    const poinEl = document.getElementById('poin');  
    const btnTambah = document.getElementById('btnTambah');  
    const totalPoinEl = document.getElementById('totalPoin');  
    const tabelBody = document.querySelector('#tabelKerjaan tbody');  
    const btnToggleHistory = document.getElementById('btnToggleHistory');  
    const historyTableContainer = document.getElementById('historyTableContainer');  
    const layananChartCanvas = document.getElementById('layananChart');  
    const statHarianEl = document.getElementById('statHarian');  
    const statMingguanEl = document.getElementById('statMingguan');  
    const statBulananEl = document.getElementById('statBulanan');  
    const weeklyTargetInput = document.getElementById('weeklyTargetInput');  
    const progressBar = document.getElementById('progressBar');  
    const progressText = document.getElementById('progressText');  


    // --- FUNGSI UTAMA & INISIALISASI ---  

    function initializeApp() {  
      console.log("Inisialisasi Aplikasi Modern...");  
      loadThemePreference();  
      // Tunda sedikit remove splash agar tema sempat diterapkan  
      setTimeout(removeSplashShowApp, 50); // Penundaan kecil saja  
      try {  
        tanggalEl.valueAsDate = new Date();  
        loadTarget();  
        loadFromLocalStorage();  
        updateToggleButtonStyle();  
        renderTabel();  
        updateTotalPoin();  
        updateStatistikPoin(); // Ini akan memanggil updateProgressBar juga  
        setupEventListeners();  
        cekOnlineGoogleSheet();  
      } catch(err) {  
        console.error("Error saat inisialisasi:", err);  
        alert("Gagal memuat aplikasi sepenuhnya. Cek konsol untuk detail.");  
        // Pastikan splash screen hilang meskipun ada error  
        removeSplashShowApp();  
      }  
    }  

    function removeSplashShowApp() {  
        if (splashScreen && splashScreen.style.display !== 'none') {  
            splashScreen.style.display = 'none';  
            if (mainApp) mainApp.style.display = 'block'; // Pastikan main app tampil  
            console.log("Splash screen dihapus, aplikasi ditampilkan.");  
        }  
    }  


     function setupEventListeners() {  
      layananEl.addEventListener('change', populatePaket);  
      paketEl.addEventListener('change', updatePoinDisplay);  
      jumlahEl.addEventListener('input', updatePointByJumlah);  
      btnTambah.addEventListener('click', tambahKerjaan);  
      btnToggleHistory.addEventListener('click', toggleHistory);  
      darkModeToggle.addEventListener('click', toggleDarkMode);  
      weeklyTargetInput.addEventListener('change', handleTargetChange);  
      setInterval(cekOnlineGoogleSheet, 300000); // 5 menit  
    }  

    function cekOnlineGoogleSheet() {  
        // PERBAIKAN: Gunakan variabel statusOnline yg sudah benar  
        statusOnline.classList.add('loading');  
        statusOnline.classList.remove('online', 'offline');  
        statusText.textContent = "Memeriksa...";  

        fetch(API_URL + '?cache_bust=' + Date.now(), { cache: "no-store" })  
            .then(response => {  
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }  
                return response.json();  
            })  
            .then(data => {  
                online = true;  
                statusOnline.classList.remove('loading', 'offline');  
                statusOnline.classList.add('online');  
                statusText.textContent = "Online";  
                if (data && Array.isArray(data.data)) {  
                    processLayananData(data.data);  
                } else {  
                    handleFetchError("Data API tidak valid");  
                }  
            })  
            .catch(err => {  
                handleFetchError(err.message);  
            });  
            // Tidak perlu finally untuk hapus loading, krn handleFetchError/success sudah atur kelasnya  
    }  

     function handleFetchError(errorMessage) {  
        online = false;  
        // PERBAIKAN: Gunakan variabel statusOnline yg sudah benar  
        statusOnline.classList.remove('loading', 'online');  
        statusOnline.classList.add('offline');  
        statusText.textContent = "Offline";  
        if (Object.keys(layananData).length === 0) {  
            layananData = {};  
            layananEl.innerHTML = '<option value="">Gagal Memuat (Offline)</option>';  
            paketEl.innerHTML = '<option value="">Pilih Layanan Dulu</option>';  
            updatePoinDisplay();  
        }  
        console.error("Fetch error:", errorMessage);  
    }  

     function processLayananData(apiData) {  
        layananData = {};  
        apiData.forEach(row => {  
          if (row && typeof row.layanan === 'string' && row.layanan.trim() !== '' &&  
              typeof row.paket === 'string' && row.paket.trim() !== '' && !isNaN(Number(row.poin))) {  
            const layanan = row.layanan.trim();  
            if (!layananData[layanan]) layananData[layanan] = [];  
            layananData[layanan].push({ paket: row.paket.trim(), poin: Number(row.poin) });  
          } else {  
            console.warn("Skipping invalid row:", row);  
          }  
        });  
        populateLayanan();  
        populatePaket();  
        updatePoinDisplay();  
    }  


    function populateLayanan() {  
      const currentLayanan = layananEl.value;  
      layananEl.innerHTML = '<option value="">-- Pilih Layanan --</option>';  
      Object.keys(layananData).sort().forEach(layanan => {  
        const opt = document.createElement('option');  
        opt.value = layanan; opt.textContent = layanan;  
        layananEl.appendChild(opt);  
      });  
      if (layananData[currentLayanan]) layananEl.value = currentLayanan;  
      // Jika layanan sebelumnya tidak valid setelah refresh, reset paket  
      if (!layananData[currentLayanan]) {  
          populatePaket(); // Ini akan mereset paket  
      }  
    }  

    function populatePaket() {  
      const selectedLayanan = layananEl.value;  
      paketEl.innerHTML = '<option value="">-- Pilih Paket --</option>';  
      if (selectedLayanan && layananData[selectedLayanan]) {  
        layananData[selectedLayanan].sort((a, b) => a.paket.localeCompare(b.paket)).forEach(obj => {  
          const opt = document.createElement('option');  
          opt.value = obj.paket;  
          opt.textContent = `${obj.paket} (${obj.poin} poin)`;  
          paketEl.appendChild(opt);  
        });  
      }  
      updatePoinDisplay();  
    }  

    function updatePoinDisplay() {  
      const selectedLayanan = layananEl.value;  
      const selectedPaket = paketEl.value;  
      let poinPerItem = 0;  
      if (selectedLayanan && selectedPaket && layananData[selectedLayanan]) {  
        const item = layananData[selectedLayanan].find(p => p.paket === selectedPaket);  
        poinPerItem = item ? item.poin : 0;  
      }  
      const jumlah = parseInt(jumlahEl.value) || 0;  
      if (jumlah < 0) jumlahEl.value = 0; // Pastikan jumlah tidak negatif  
      poinSatuanEl.textContent = poinPerItem;  
      displayJumlahEl.textContent = Math.max(0, jumlah);  
      poinEl.textContent = (poinPerItem * Math.max(0, jumlah)).toFixed(2);  
    }  

     function updatePointByJumlah() {  
        if (parseInt(jumlahEl.value) < 0) jumlahEl.value = 0;  
        updatePoinDisplay();  
    }  


    function tambahKerjaan() {  
      const tanggal = tanggalEl.value;  
      const layanan = layananEl.value;  
      const paket = paketEl.value;  
      const jumlah = parseInt(jumlahEl.value);  
      const poinSatuan = parseFloat(poinSatuanEl.textContent);  
      const poinTotal = parseFloat(poinEl.textContent);  

      if (!tanggal || !layanan || !paket || isNaN(jumlah) || jumlah <= 0 || isNaN(poinTotal)) {  
        alert('Harap lengkapi semua field dengan benar (Jumlah harus > 0)!');  
        return;  
      }  

      const newItem = {  
        id: Date.now(), tanggal: tanggal, layanan: layanan, paket: paket,  
        jumlah: jumlah, poinSatuan: poinSatuan, poin: poinTotal  
      };  
      daftarKerjaan.unshift(newItem);  

      saveToLocalStorage();  
      renderSingleRow(newItem, true);  
      updateTotalPoin();  
      updateStatistikPoin(); // Ini akan update progress bar juga  
      if (chartInstance && document.getElementById('chartTab').classList.contains('active-content')) {  
        renderLayananChart();  
      }  

      // Feedback visual tombol Tambah  
      const originalBtnHtml = btnTambah.innerHTML;  
      btnTambah.innerHTML = `<i class="fa-solid fa-check"></i> Ditambahkan!`;  
      btnTambah.classList.add('btn-feedback');  
      btnTambah.disabled = true;  
      setTimeout(() => {  
          btnTambah.innerHTML = originalBtnHtml;  
          btnTambah.classList.remove('btn-feedback');  
          btnTambah.disabled = false;  
      }, 1500);  

      paketEl.value = '';  
      jumlahEl.value = '1';  
      updatePoinDisplay();  
    }  

    function renderTabel() {  
        tabelBody.innerHTML = '';  
        if (daftarKerjaan.length === 0) {  
            tabelBody.innerHTML = '<tr><td colspan="3" style="text-align:center; font-style: italic; padding: 25px; color: var(--text-muted);">Belum ada data kerjaan</td></tr>';  
        } else {  
            daftarKerjaan.forEach((item) => {  
                renderSingleRow(item, false);  
            });  
        }  
        updateToggleButtonStyle(); // Pindahkan ini agar selalu update setelah render  
    }  


    function renderSingleRow(k, animate = false) {  
        const tr = document.createElement('tr');  
        tr.dataset.id = k.id;  
        tr.innerHTML = `  
            <td>${formatTanggal(k.tanggal)}</td>  
            <td title="${k.layanan} - ${k.paket} (${k.jumlah}x)">${k.layanan} - ${k.paket}</td>  
            <td>  
              <div class="poin-column">  
                <span>${k.poin.toFixed(2)}</span>  
                <button class="btn-icon" onclick="hapusKerjaan(${k.id})" title="Hapus"><i class="fas fa-trash-alt"></i></button>  
              </div>  
            </td>  
          `;  

        const placeholder = tabelBody.querySelector('td[colspan="3"]');  
        if (placeholder) placeholder.parentElement.remove();  

        tabelBody.prepend(tr);  

        if (animate) {  
            tr.classList.add('row-fade-in');  
            tr.addEventListener('animationend', () => {  
                 if(tr) tr.classList.remove('row-fade-in'); // Hapus kelas setelah selesai  
            }, { once: true }); // Hanya jalankan sekali  
        }  
    }  

    function hapusKerjaan(id) {  
        const itemIndex = daftarKerjaan.findIndex(item => item.id === id);  
        if (itemIndex === -1) return;  
        const item = daftarKerjaan[itemIndex];  

        if (confirm(`Yakin hapus "${item.layanan} - ${item.paket}" (${formatTanggal(item.tanggal)})?`)) {  
            const rowElement = tabelBody.querySelector(`tr[data-id="${id}"]`);  
            daftarKerjaan.splice(itemIndex, 1); // Hapus dari array dulu  

            if (rowElement) {  
                rowElement.classList.add('row-fade-out');  
                rowElement.addEventListener('animationend', () => {  
                    if(rowElement) rowElement.remove();  
                    if (daftarKerjaan.length === 0) { // Cek SETELAH data dihapus  
                         tabelBody.innerHTML = '<tr><td colspan="3" style="text-align:center; font-style: italic; padding: 25px; color: var(--text-muted);">Belum ada data kerjaan</td></tr>';  
                    }  
                }, { once: true });  
            } else {  
                 // Jika elemen tidak ditemukan (jarang terjadi), render ulang saja  
                 renderTabel();  
            }  

            saveToLocalStorage();  
            updateTotalPoin();  
            updateStatistikPoin(); // Ini akan update progress bar juga  
            if (chartInstance && document.getElementById('chartTab').classList.contains('active-content')) {  
                renderLayananChart();  
            }  
             // Jika elemen tidak ada saat klik (misal render belum selesai), pastikan cek kekosongan  
             if (daftarKerjaan.length === 0 && !tabelBody.querySelector('tr')) {  
                tabelBody.innerHTML = '<tr><td colspan="3" style="text-align:center; font-style: italic; padding: 25px; color: var(--text-muted);">Belum ada data kerjaan</td></tr>';  
             }  
        }  
    }  
    window.hapusKerjaan = hapusKerjaan; // Expose to global scope  


    function toggleHistory() {  
      isHistoryVisible = !isHistoryVisible;  
      localStorage.setItem(HISTORY_VISIBLE_KEY, isHistoryVisible);  
      updateToggleButtonStyle(); // Cukup update tombol & visibility  
    }  

    function updateToggleButtonStyle() {  
        const iconClass = isHistoryVisible ? 'fa-eye-slash' : 'fa-eye';  
        const text = isHistoryVisible ? ' Sembunyikan' : ' Tampilkan';  
        btnToggleHistory.innerHTML = `<i class="fas ${iconClass}"></i>${text}`;  
        btnToggleHistory.classList.toggle('btn-warning', isHistoryVisible);  
        btnToggleHistory.classList.toggle('btn-success', !isHistoryVisible);  
        // Langsung atur display container  
        historyTableContainer.style.display = isHistoryVisible ? 'block' : 'none';  
    }  


    function updateTotalPoin() {  
      const total = daftarKerjaan.reduce((sum, item) => sum + item.poin, 0);  
      totalPoinEl.textContent = total.toFixed(2);  
    }  

     function formatTanggal(tanggalString){  
      // Pastikan tanggal valid sebelum format  
      if (!tanggalString || isNaN(new Date(tanggalString).getTime())) return "Tgl Invalid";  
      try {  
        // Menggunakan UTC agar tidak terpengaruh timezone browser saat konversi  
        const t = new Date(tanggalString + 'T00:00:00Z'); // Anggap input sbg UTC midnight  
        return t.toLocaleDateString('id-ID', { year:'numeric', month:'2-digit', day:'2-digit', timeZone: 'UTC' }); // Tampilkan sbg UTC  
      } catch (e) { return "Error Tgl"; }  
    }  

    // --- LOCAL STORAGE ---  
    function saveToLocalStorage() { /* ... (sama) ... */ }  
    function loadFromLocalStorage() { /* ... (sama, pastikan sort) ... */ }  

    // --- DARK MODE ---  
    function loadThemePreference() { /* ... (sama) ... */ }  
    function toggleDarkMode() { /* ... (sama, pastikan render chart jika aktif) ... */ }  

    // --- PROGRESS BAR ---  
    function loadTarget() { /* ... (sama) ... */ }  
    function saveTarget() { /* ... (sama) ... */ }  
    function handleTargetChange() { /* ... (sama) ... */ }  
    function updateProgressBar() { /* ... (sama) ... */ }  

    // --- TAB & CHART/STATS ---  
    function showTab(tabId, buttonElement){ /* ... (sama, panggil render/update saat tab aktif) ... */ }  
    function renderLayananChart() { /* ... (sama, termasuk deteksi tema) ... */ }  
    function updateStatistikPoin() { /* ... (sama, panggil updateProgressBar di akhir) ... */ }  


    // --- Backup & Restore ---  
    function backupData() { /* ... (sama) ... */ }  
    function restoreData(event) { /* ... (sama, pastikan panggil semua fungsi update yg relevan) ... */ }  


    // --- Jalankan Aplikasi Saat DOM Siap ---  
    // Pastikan initializeApp dipanggil setelah DOM siap  
    if (document.readyState === 'loading') {  
        document.addEventListener('DOMContentLoaded', initializeApp);  
    } else {  
        // DOM sudah siap  
        initializeApp();  
    }  

  </script>  
</body>  
</html>
