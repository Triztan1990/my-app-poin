<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>PinBonus AI - MultiDevice v6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --accent: #1d4ed8; }
    body { background-color: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; transition: 0.3s; }
    .glass { background: var(--card); border: 1px solid rgba(0,0,0,0.05); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    
    /* Responsive Navigation */
    @media (min-width: 768px) {
        .app-container { display: flex; flex-direction: row-reverse; max-width: 1200px; margin: auto; gap: 20px; padding: 20px; }
        #navBar { position: sticky; top: 20px; height: fit-content; width: 250px; flex-direction: column; border-radius: 2rem; padding: 30px 10px; gap: 15px; display: flex !important; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .nav-btn { width: 100%; flex-direction: row !important; padding: 15px 20px; border-radius: 1.5rem; justify-content: flex-start; gap: 15px !important; }
        .main-content { flex: 1; }
        #footerTotal { position: sticky; bottom: 20px; margin-top: 20px; left: 0; right: 0; }
        #loginScreen h1 { font-size: 4rem; }
    }
    
    .nav-active { background: #eff6ff; color: var(--accent) !important; opacity: 1 !important; }
    .acc-content { max-height: 0; overflow: hidden; transition: 0.3s; }
    .acc-item.open .acc-content { max-height: 200px; padding: 15px 0; border-top: 1px solid #f1f5f9; }
    .acc-arrow { transition: 0.3s; }
    .acc-item.open .acc-arrow { transform: rotate(180deg); }
    .blur-mode { filter: blur(12px); pointer-events: none; }
  </style>
</head>
<body class="min-h-screen">

  <div id="loginScreen" class="fixed inset-0 z-[100] bg-slate-50 flex flex-col items-center justify-center p-6 text-center">
      <div class="w-24 h-24 bg-blue-700 rounded-[2.5rem] mb-8 flex items-center justify-center shadow-2xl shadow-blue-200 animate-bounce">
          <i class="fa fa-cloud text-white text-5xl"></i>
      </div>
      <h1 class="text-4xl md:text-6xl font-800 text-slate-800 tracking-tighter mb-4">PinBonus AI</h1>
      <p class="text-xs md:text-sm text-slate-400 font-bold uppercase tracking-[0.3em] mb-12">Universal Cloud Access</p>
      <button id="btnLogin" class="flex items-center gap-4 bg-white px-12 py-5 rounded-[2rem] shadow-xl border border-slate-100 font-black hover:shadow-2xl active:scale-95 transition-all text-slate-700">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6"> Masuk dengan Google
      </button>
  </div>

  <div id="mainApp" class="hidden">
    <div class="app-container">
        
        <main class="main-content px-4 py-6 md:py-0">
            <div class="flex justify-between items-center mb-8 bg-white/50 p-4 rounded-3xl backdrop-blur-sm border border-white">
                <div>
                    <h1 class="text-2xl font-800 text-blue-700 tracking-tighter">Dashboard</h1>
                    <p id="userName" class="text-[10px] font-black opacity-40 uppercase tracking-widest">Memuat Profil...</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="togglePrivacy()" class="w-11 h-11 rounded-2xl glass flex items-center justify-center text-blue-600 shadow-sm"><i class="fa fa-shield"></i></button>
                    <button onclick="logout()" class="w-11 h-11 rounded-2xl glass flex items-center justify-center text-red-500 shadow-sm"><i class="fa fa-sign-out"></i></button>
                </div>
            </div>

            <div id="viewInput" class="tab-content active space-y-6">
                <div class="glass rounded-[2.5rem] p-8 md:p-12 shadow-xl border-white border-4">
                    <h2 class="text-lg font-800 mb-6 flex items-center gap-3"><i class="fa fa-pencil text-blue-600"></i> Catat Pekerjaan</h2>
                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <select id="cat" class="w-full p-4 glass border-none rounded-2xl text-xs font-bold ring-1 ring-slate-100 outline-none"></select>
                        <select id="svc" class="w-full p-4 glass border-none rounded-2xl text-xs font-bold ring-1 ring-slate-100 outline-none" disabled></select>
                    </div>
                    <select id="sku" class="w-full p-5 glass border-none rounded-2xl text-sm font-black ring-2 ring-blue-50 outline-none mb-4" disabled></select>
                    <input type="text" id="orderId" placeholder="Masukkan ID Order..." class="w-full p-5 glass rounded-2xl text-sm font-bold outline-none ring-2 ring-slate-50 mb-6">
                    <button id="addBtn" class="w-full bg-blue-700 text-white py-5 rounded-[2rem] font-800 uppercase tracking-widest text-sm shadow-xl shadow-blue-100 active:scale-95 transition-all">Simpan ke Awan</button>
                </div>
            </div>

            <div id="viewStats" class="tab-content space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="glass p-8 rounded-[2.5rem] border-l-[12px] border-blue-600 flex items-center gap-6">
                        <div class="relative w-20 h-20 shrink-0">
                            <svg class="w-full h-full -rotate-90" viewBox="0 0 36 36"><circle cx="18" cy="18" r="16" fill="none" stroke="#f1f5f9" stroke-width="3"></circle><circle id="circleProgress" cx="18" cy="18" r="16" fill="none" stroke="#1d4ed8" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round"></circle></svg>
                            <div class="absolute inset-0 flex items-center justify-center font-900 text-sm" id="percentText">0%</div>
                        </div>
                        <div>
                            <p class="text-[10px] font-black opacity-30 uppercase">Target Hari Ini</p>
                            <p id="targetLabel" class="text-xl font-800 text-slate-800">Rp 0 / 500k</p>
                        </div>
                    </div>
                    <div class="glass rounded-[2.5rem] p-8 h-80"><canvas id="statsChart"></canvas></div>
                </div>
            </div>

            <div id="viewHistory" class="tab-content space-y-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-black text-xs text-blue-600 uppercase tracking-widest">Riwayat Database</h3>
                    <div class="flex gap-2">
                        <button onclick="sendWA()" class="p-3 bg-green-50 text-green-600 rounded-xl"><i class="fa fa-whatsapp"></i></button>
                        <button onclick="openExportMenu()" class="p-3 bg-blue-50 text-blue-600 rounded-xl"><i class="fa fa-file-excel-o"></i></button>
                    </div>
                </div>
                <div id="jobListContainer" class="grid md:grid-cols-2 gap-4 pb-20">
                    <ul id="jobList" class="md:contents space-y-3"></ul>
                </div>
            </div>

            <div id="footerTotal" class="glass rounded-3xl p-6 shadow-2xl border-l-[8px] border-blue-600 flex justify-between items-center border border-white hidden">
                <div><p class="text-[10px] font-black opacity-40 uppercase tracking-widest">Bonus Berjalan</p><p class="text-3xl font-900 text-blue-700 tracking-tighter">Rp <span id="totalDisplay">0</span></p></div>
                <button onclick="toggleVoice()" class="w-14 h-14 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center active:scale-90 transition-all shadow-inner"><i id="voiceIcon" class="fa fa-volume-up text-xl"></i></button>
            </div>
        </main>

        <nav id="navBar" class="fixed bottom-0 left-0 right-0 h-24 glass border-t border-slate-100 flex justify-around items-center px-6 z-50 rounded-t-[3rem] hidden md:shadow-none">
            <button onclick="switchTab('input')" id="navIn" class="nav-btn nav-active flex flex-col items-center gap-1 opacity-40 transition-all"><i class="fa fa-edit text-2xl"></i><span class="text-[10px] font-black uppercase">Input</span></button>
            <button onclick="switchTab('stats')" id="navSta" class="nav-btn flex flex-col items-center gap-1 opacity-40 transition-all"><i class="fa fa-pie-chart text-2xl"></i><span class="text-[10px] font-black uppercase">Statistik</span></button>
            <button onclick="switchTab('history')" id="navHis" class="nav-btn flex flex-col items-center gap-1 opacity-40 transition-all"><i class="fa fa-database text-2xl"></i><span class="text-[10px] font-black uppercase">Laporan</span></button>
        </nav>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBaulpvROT6vO1-LjK3bae3ETnpWz4irIw",
      authDomain: "pinbonus-kalkulasi.firebaseapp.com",
      projectId: "pinbonus-kalkulasi",
      storageBucket: "pinbonus-kalkulasi.firebasestorage.app",
      messagingSenderId: "950589733342",
      appId: "1:950589733342:web:6bbc9647077a8c40e1454f",
      measurementId: "G-ZDX07SGZC8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let userUID = null, cart = [], master = [], myChart = null, VOICE_ON = true, isPrivate = false;

    const els = {
      login: document.getElementById('loginScreen'), app: document.getElementById('mainApp'),
      nav: document.getElementById('navBar'), footer: document.getElementById('footerTotal'),
      cat: document.getElementById('cat'), svc: document.getElementById('svc'), sku: document.getElementById('sku'),
      oid: document.getElementById('orderId'), list: document.getElementById('jobList'), total: document.getElementById('totalDisplay')
    };

    document.getElementById('btnLogin').onclick = () => signInWithPopup(auth, provider);
    window.logout = () => { if(confirm("Keluar dari aplikasi?")) signOut(auth).then(() => location.reload()); };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            userUID = user.uid;
            document.getElementById('userName').innerText = user.displayName;
            els.login.classList.add('hidden'); els.app.classList.remove('hidden');
            els.nav.classList.remove('hidden'); els.footer.classList.remove('hidden');
            initData(); speak("Selamat bekerja, " + user.displayName);
        }
    });

    async function initData() {
        try {
            const r = await fetch("https://script.google.com/macros/s/AKfycbyUtuyUhIXT9uZwd6xZ38JV18rzFUns87AvS4AsST1eun1BQAFtNZGfpmv-mthucDDP/exec");
            const j = await r.json(); master = j.data;
            els.cat.innerHTML = '<option value="">Pilih Kategori...</option>' + [...new Set(master.map(i => i.category))].sort().map(c => `<option value="${c}">${c}</option>`).join('');
        } catch(e) { console.error("Error data"); }
        onSnapshot(doc(db, "users", userUID), (d) => { if (d.exists()) { cart = d.data().bonus || []; render(); } });
    }

    els.cat.onchange = () => { const c = els.cat.value; els.svc.innerHTML = '<option value="">Layanan...</option>'; els.svc.disabled = !c; if(c) els.svc.innerHTML += [...new Set(master.filter(i => i.category === c).map(i => i.service))].sort().map(s => `<option value="${s}">${s}</option>`).join(''); };
    els.svc.onchange = () => { const c = els.cat.value, s = els.svc.value; els.sku.innerHTML = '<option value="">Pilih SKU...</option>'; els.sku.disabled = !s; if(s) els.sku.innerHTML += master.filter(i => i.category === c && i.service === s).map(i => `<option value="${i.nominal_angka}" data-n="${i.sku_name}">${i.sku_name}</option>`).join(''); };

    document.getElementById('addBtn').onclick = async () => {
        const p = parseFloat(els.sku.value), n = els.sku.options[els.sku.selectedIndex]?.getAttribute('data-n'), oid = els.oid.value;
        if(!p || !n) return;
        const data = { id: Date.now(), order: oid || "-", name: n, price: p, time: new Date().toLocaleTimeString('id-ID'), date: new Date().toLocaleDateString('id-ID')};
        await setDoc(doc(db, "users", userUID), { bonus: arrayUnion(data) }, { merge: true });
        els.oid.value = ""; speak(n + " dicatat.");
    };

    window.deleteItem = async (id) => {
        if(confirm("Hapus data selamanya?")) {
            const updated = cart.filter(i => i.id !== id);
            await setDoc(doc(db, "users", userUID), { bonus: updated }, { merge: true });
        }
    };

    window.render = () => {
        els.list.innerHTML = ""; let tot = 0; const today = new Date().toLocaleDateString('id-ID');
        [...cart].sort((a,b) => b.id - a.id).forEach((item) => {
            if(item.date === today) tot += item.price;
            els.list.innerHTML += `
            <li id="acc-${item.id}" class="acc-item glass rounded-[1.8rem] p-6 mb-2 border-l-8 border-blue-600 shadow-sm">
                <div class="flex justify-between items-center">
                    <div class="cursor-pointer flex-1" onclick="document.getElementById('acc-${item.id}').classList.toggle('open')">
                        <p class="text-[10px] font-900 uppercase opacity-40 leading-none">${item.name}</p>
                        <p class="text-md font-black text-blue-700 mt-1">Rp${item.price.toLocaleString('id-ID')}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="deleteItem(${item.id})" class="text-red-300 hover:text-red-600 p-2"><i class="fa fa-trash"></i></button>
                        <i class="fa fa-chevron-down acc-arrow text-slate-300"></i>
                    </div>
                </div>
                <div class="acc-content text-[10px] font-bold text-slate-400">
                    <p class="mb-1 uppercase tracking-widest text-slate-600">ID ORDER: ${item.order}</p>
                    <p class="uppercase tracking-widest">Waktu: ${item.date} | ${item.time}</p>
                </div>
            </li>`;
        });
        els.total.innerText = tot.toLocaleString('id-ID');
        const per = Math.min((tot / 500000) * 100, 100);
        document.getElementById('circleProgress').style.strokeDasharray = `${per}, 100`;
        document.getElementById('percentText').innerText = Math.floor(per) + '%';
        document.getElementById('targetLabel').innerText = `Rp ${tot.toLocaleString('id-ID')} / 500k`;
        updateChart();
    };

    window.switchTab = (t) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('view' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
        document.getElementById(t === 'input' ? 'navIn' : t === 'stats' ? 'navSta' : 'navHis').classList.add('nav-active');
    };
    window.togglePrivacy = () => { isPrivate = !isPrivate; document.getElementById('jobList').classList.toggle('blur-mode'); document.getElementById('footerTotal').classList.toggle('blur-mode'); };
    window.toggleVoice = () => { VOICE_ON = !VOICE_ON; document.getElementById('voiceIcon').className = VOICE_ON ? "fa fa-volume-up" : "fa fa-volume-off opacity-30"; };
    function speak(t) { if (VOICE_ON) { window.speechSynthesis.cancel(); const m = new SpeechSynthesisUtterance(t); m.lang = 'id-ID'; window.speechSynthesis.speak(m); } }
    function updateChart() {
        const counts = {}; cart.forEach(i => counts[i.name] = (counts[i.name] || 0) + 1);
        if (myChart) myChart.destroy();
        const ctx = document.getElementById('statsChart').getContext('2d');
        myChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#1d4ed8', '#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 9, weight: 'bold' } } } } } });
    }
    window.sendWA = () => { let t = "*LAPORAN KOMISI*\n"; cart.filter(i => i.date === new Date().toLocaleDateString('id-ID')).forEach(i => t += `- ${i.name}: Rp${i.price.toLocaleString()}\n`); window.open("https://wa.me/?text=" + encodeURIComponent(t + "\n*TOTAL: Rp" + els.total.innerText + "*")); };
    window.openExportMenu = () => { const ws = XLSX.utils.json_to_sheet(cart); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Audit"); XLSX.writeFile(wb, "Audit_Cloud_MultiDevice.xlsx"); };
  </script>
</body>
</html>
